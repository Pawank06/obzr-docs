# API Integration

Connect your agents to external APIs and services for enhanced functionality and data access.

## Overview

API integration allows agents to interact with external services, fetch data, and perform actions beyond their built-in capabilities. AgentOS provides tools to easily integrate with REST APIs, GraphQL endpoints, and webhooks.

## REST API Integration

### Basic HTTP Requests

```typescript
import { Agent, capabilities } from '@agentos/sdk';

const agent = new Agent({
  name: 'APIAgent',
  model: 'gpt-4',
});

agent.addCapability({
  name: 'fetchUserData',
  description: 'Fetch user data from API',
  parameters: {
    userId: { type: 'string', required: true },
  },
  execute: async ({ userId }) => {
    const response = await fetch(
      `https://api.example.com/users/${userId}`,
      {
        headers: {
          'Authorization': `Bearer ${process.env.API_KEY}`,
          'Content-Type': 'application/json',
        },
      }
    );
    return await response.json();
  },
});
```

### POST Requests

```typescript
agent.addCapability({
  name: 'createUser',
  description: 'Create a new user',
  parameters: {
    name: { type: 'string', required: true },
    email: { type: 'string', required: true },
  },
  execute: async ({ name, email }) => {
    const response = await fetch('https://api.example.com/users', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ name, email }),
    });
    return await response.json();
  },
});
```

### Error Handling

```typescript
agent.addCapability({
  name: 'apiCall',
  description: 'Make API call with error handling',
  execute: async (params) => {
    try {
      const response = await fetch('https://api.example.com/data');
      
      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }
      
      return await response.json();
    } catch (error) {
      return {
        success: false,
        error: error.message,
        retryable: error.code === 'ECONNRESET',
      };
    }
  },
});
```

## GraphQL Integration

### Query Execution

```typescript
import { GraphQLClient } from 'graphql-request';

const graphqlClient = new GraphQLClient('https://api.example.com/graphql', {
  headers: {
    authorization: `Bearer ${process.env.API_KEY}`,
  },
});

agent.addCapability({
  name: 'queryGraphQL',
  description: 'Execute GraphQL query',
  parameters: {
    query: { type: 'string', required: true },
    variables: { type: 'object' },
  },
  execute: async ({ query, variables }) => {
    return await graphqlClient.request(query, variables);
  },
});
```

### Mutations

```typescript
agent.addCapability({
  name: 'createPost',
  description: 'Create a new post via GraphQL',
  parameters: {
    title: { type: 'string', required: true },
    content: { type: 'string', required: true },
  },
  execute: async ({ title, content }) => {
    const mutation = `
      mutation CreatePost($title: String!, $content: String!) {
        createPost(title: $title, content: $content) {
          id
          title
          createdAt
        }
      }
    `;
    return await graphqlClient.request(mutation, { title, content });
  },
});
```

## Authentication

### API Keys

```typescript
const apiConfig = {
  baseURL: 'https://api.example.com',
  headers: {
    'X-API-Key': process.env.API_KEY,
  },
};
```

### OAuth 2.0

```typescript
import { OAuth2Client } from '@agentos/oauth';

const oauth = new OAuth2Client({
  clientId: process.env.OAUTH_CLIENT_ID,
  clientSecret: process.env.OAUTH_CLIENT_SECRET,
  redirectUri: 'http://localhost:3000/callback',
});

agent.addCapability({
  name: 'authenticatedRequest',
  description: 'Make authenticated API request',
  execute: async (params) => {
    const token = await oauth.getAccessToken();
    const response = await fetch('https://api.example.com/data', {
      headers: {
        'Authorization': `Bearer ${token}`,
      },
    });
    return await response.json();
  },
});
```

### JWT Tokens

```typescript
import jwt from 'jsonwebtoken';

function generateToken() {
  return jwt.sign(
    { userId: 'user-123' },
    process.env.JWT_SECRET,
    { expiresIn: '1h' }
  );
}

agent.addCapability({
  name: 'jwtRequest',
  description: 'Make JWT authenticated request',
  execute: async (params) => {
    const token = generateToken();
    const response = await fetch('https://api.example.com/data', {
      headers: {
        'Authorization': `Bearer ${token}`,
      },
    });
    return await response.json();
  },
});
```

## Rate Limiting

### Built-in Rate Limiting

```typescript
agent.addCapability({
  name: 'rateLimitedAPI',
  description: 'API call with rate limiting',
  rateLimit: {
    maxCalls: 100,
    window: 60000, // 1 minute
  },
  execute: async (params) => {
    return await fetch('https://api.example.com/data');
  },
});
```

### Custom Rate Limiting

```typescript
import { RateLimiter } from '@agentos/sdk';

const limiter = new RateLimiter({
  maxRequests: 10,
  perMilliseconds: 1000,
});

agent.addCapability({
  name: 'customRateLimit',
  description: 'API with custom rate limiting',
  execute: async (params) => {
    await limiter.wait();
    return await fetch('https://api.example.com/data');
  },
});
```

## Webhooks

### Receiving Webhooks

```typescript
import express from 'express';

const app = express();

app.post('/webhook', express.json(), async (req, res) => {
  const event = req.body;
  
  // Process webhook
  await agent.run({
    input: `Process webhook event: ${JSON.stringify(event)}`,
    context: { webhookEvent: event },
  });
  
  res.status(200).send('OK');
});

app.listen(3000);
```

### Webhook Verification

```typescript
import crypto from 'crypto';

function verifyWebhook(payload, signature, secret) {
  const hmac = crypto.createHmac('sha256', secret);
  const digest = hmac.update(payload).digest('hex');
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(digest)
  );
}

app.post('/webhook', express.raw({ type: 'application/json' }), (req, res) => {
  const signature = req.headers['x-webhook-signature'];
  
  if (!verifyWebhook(req.body, signature, process.env.WEBHOOK_SECRET)) {
    return res.status(401).send('Invalid signature');
  }
  
  // Process webhook
  res.status(200).send('OK');
});
```

## API Client Libraries

### Using SDK Clients

```typescript
import { Stripe } from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

agent.addCapability({
  name: 'createPayment',
  description: 'Create a Stripe payment',
  parameters: {
    amount: { type: 'number', required: true },
    currency: { type: 'string', required: true },
  },
  execute: async ({ amount, currency }) => {
    const paymentIntent = await stripe.paymentIntents.create({
      amount,
      currency,
    });
    return paymentIntent;
  },
});
```

### Multiple Services

```typescript
import { Twilio } from 'twilio';
import { SendGrid } from '@sendgrid/mail';

const twilio = new Twilio(
  process.env.TWILIO_SID,
  process.env.TWILIO_TOKEN
);

const sendgrid = new SendGrid();
sendgrid.setApiKey(process.env.SENDGRID_API_KEY);

agent.addCapabilities([
  {
    name: 'sendSMS',
    description: 'Send SMS via Twilio',
    execute: async ({ to, message }) => {
      return await twilio.messages.create({
        to,
        from: process.env.TWILIO_PHONE,
        body: message,
      });
    },
  },
  {
    name: 'sendEmail',
    description: 'Send email via SendGrid',
    execute: async ({ to, subject, body }) => {
      return await sendgrid.send({
        to,
        from: process.env.FROM_EMAIL,
        subject,
        text: body,
      });
    },
  },
]);
```

## Retry Logic

### Exponential Backoff

```typescript
async function fetchWithRetry(url, options, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const response = await fetch(url, options);
      if (response.ok) return await response.json();
      
      if (response.status >= 500) {
        // Retry on server errors
        await delay(Math.pow(2, i) * 1000);
        continue;
      }
      
      throw new Error(`HTTP ${response.status}`);
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await delay(Math.pow(2, i) * 1000);
    }
  }
}
```

### Circuit Breaker

```typescript
import { CircuitBreaker } from '@agentos/sdk';

const breaker = new CircuitBreaker({
  failureThreshold: 5,
  resetTimeout: 60000,
});

agent.addCapability({
  name: 'resilientAPI',
  description: 'API with circuit breaker',
  execute: async (params) => {
    return await breaker.execute(async () => {
      return await fetch('https://api.example.com/data');
    });
  },
});
```

## Best Practices

- Always handle API errors gracefully
- Implement proper authentication and security
- Use rate limiting to respect API limits
- Cache responses when appropriate
- Log API calls for debugging
- Validate API responses
- Use timeouts to prevent hanging requests
- Implement retry logic for transient failures
- Monitor API usage and costs
- Keep API keys secure (use environment variables)

## Testing

```typescript
import { expect } from 'chai';
import nock from 'nock';

describe('API Integration', () => {
  it('should fetch user data', async () => {
    nock('https://api.example.com')
      .get('/users/123')
      .reply(200, { id: '123', name: 'John' });
    
    const result = await agent.executeCapability('fetchUserData', {
      userId: '123',
    });
    
    expect(result.name).to.equal('John');
  });
});
```

## Next Steps

- **[Task Capabilities](/docs/sdk/task-capabilities)** - Learn more about capabilities
- **[Observability](/docs/observability/monitoring)** - Monitor API calls
- **[Examples](/docs/examples/saas-integration)** - See API integration examples
- **[Agent API](/docs/api/agent)** - Complete API reference

## Resources

- [API Integration Guide](https://agentos.dev/api-integration)
- [Authentication Best Practices](https://agentos.dev/auth-best-practices)
- [Rate Limiting Strategies](https://agentos.dev/rate-limiting)
